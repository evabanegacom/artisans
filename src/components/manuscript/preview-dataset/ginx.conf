worker_processes  1;

events {
  worker_connections  1024;
}

http {
  server {
    listen 80;
    server_name  localhost;

    root   /usr/share/nginx/html;
    index  index.html index.htm;
    include /etc/nginx/mime.types;

    gzip on;
    gzip_min_length 1000;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    # Security Headers
    add_header X-Frame-Options "DENY";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header X-Permitted-Cross-Domain-Policies "none";
    add_header Content-Security-Policy "
  default-src 'self' https://api.chisquares.com/api/;
  
  script-src 
    'self' 
    'unsafe-inline' 
    'unsafe-eval' 
    https://trusted.cdn.com 
    https://js.stripe.com 
    https://www.google.com/recaptcha/ 
    https://accounts.google.com/gsi/client 
    https://api.chisquares.com/api/  
    https://www.gstatic.com
    https://apis.google.com/js/api.js;
  
  connect-src 
    'self' 
    https://api.chisquares.com/api/
    https://chisquares.com/
    https://chi2.io/api/
    https://survey.chisquares.com/
    https://ai-toolkit.chisquares.com/
    https://offline-survey.chisquares.com/
    
    # Google services
    https://www.google.com/recaptcha/api2/ 
    https://www.recaptcha.net/recaptcha/api2/
    https://accounts.google.com/gsi/client
    https://login.microsoftonline.com/consumers
    https://login.microsoftonline.com/f8cdef31-a31e-4b4a-93e4-5f571e91255a
    
    # External APIs
    https://www.linkedin.com/oauth/v2/authorization?response_type=code
    https://www.instagram.com
    wss://chisquares-chatbot-hgwfpy6yxq-uc.a.run.app
    
    # CDNs and media
    https://cdn.pixabay.com
    https://unpkg.com/
    https://cdn.who.int/media/docs/default-source/hq-tuberculosis/global-task-force-on-tb-impact-measurement/meetings/2008-03/p20_probability_proportional_to_size.pdf?sfvrsn
    https://picsum.photos/70
    https://picsum.photos/80
    https://datavizproject.com/wp-content/uploads/types/Line-Graph.png
    
    # US Central Services
    https://api-gateway-service-hgwfpy6yxq-uc.a.run.app/api/
    https://seqlog-hgwfpy6yxq-uc.a.run.app/
    https://suggester-service-hgwfpy6yxq-uc.a.run.app/api/
    https://data-collection-service-hgwfpy6yxq-uc.a.run.app/api/
    https://chisquares-surveyweights-hgwfpy6yxq-uc.a.run.app/api/
    https://chisquares-chatbot-hgwfpy6yxq-uc.a.run.app/
    https://notification-service-e3zfegihla-uc.a.run.app/Hub/
    https://paper-questionnaire-hgwfpy6yxq-uc.a.run.app/
    https://translation-service-hgwfpy6yxq-uc.a.run.app/api/
    https://questionnaire-dataframe-service-hgwfpy6yxq-uc.a.run.app/api/
    https://sample-size-service-hgwfpy6yxq-uc.a.run.app/api/
    https://sampling-service-hgwfpy6yxq-uc.a.run.app/api/
    https://website-backend-hgwfpy6yxq-uc.a.run.app/api/
    https://website-backend-hgwfpy6yxq-uc.a.run.app/api/Recaptcha/Captcha
    https://chisquares-paperresponseservice-hgwfpy6yxq-uc.a.run.app/api/
    https://auth-service-461987414798.us-central1.run.app/
    https://billing-service-461987414798.us-central1.run.app/
    
    # EU Services
    https://analysis-rs-e3zfegihla-ue.a.run.app/
    https://ai-toolkit-1089577262652.europe-west1.run.app/
    https://aitoolkit-reference-1089577262652.europe-west1.run.app/
    https://ai-toolkit-portal-1089577262652.europe-west1.run.app/
    https://api-gateway-eu-1089577262652.europe-west1.run.app/
    https://analysis-engine-1089577262652.europe-west1.run.app/
    https://central-notification-1089577262652.europe-west1.run.app/
    https://certificate-service-1089577262652.europe-west1.run.app/
    https://chatbot-1089577262652.europe-west1.run.app/
    https://chatbot-frontend-1089577262652.europe-west1.run.app/
    https://incentive-service-1089577262652.europe-west1.run.app/
    https://portal-1089577262652.europe-west1.run.app/
    https://questionnaire-service-1089577262652.europe-west1.run.app/
    https://survey-weights-1089577262652.europe-west1.run.app/
    https://translation-callback-1089577262652.europe-west1.run.app/
    https://comment-service-1089577262652.europe-west1.run.app/
    https://configuration-service-1089577262652.europe-west1.run.app/
    https://container-portal-1089577262652.europe-west1.run.app/
    https://data-collection-1089577262652.europe-west1.run.app/
    https://file-access-1089577262652.europe-west1.run.app/
    https://survey-logic-1089577262652.europe-west1.run.app/
    https://offline-survey-1089577262652.europe-west1.run.app/
    https://paper-questionnaire-1089577262652.europe-west1.run.app/
    https://project-1089577262652.europe-west1.run.app/
    https://questionnaire-dataframes-1089577262652.europe-west1.run.app/
    https://sample-size-1089577262652.europe-west1.run.app/
    https://sampling-1089577262652.europe-west1.run.app/
    https://signal-bridge-1089577262652.europe-west1.run.app/
    https://storage-management-1089577262652.europe-west1.run.app/
    https://suggester-1089577262652.europe-west1.run.app/
    https://survey-bank-1089577262652.europe-west1.run.app/
    https://survey-portal-1089577262652.europe-west1.run.app/
    https://certificate-backend-1089577262652.europe-west1.run.app/
    https://translation-1089577262652.europe-west1.run.app/
    https://urlshortener-1089577262652.europe-west1.run.app/
    https://website-1089577262652.europe-west1.run.app/
    https://website-backend-1089577262652.europe-west1.run.app/;
  
  style-src 
    'self' 
    'unsafe-inline' 
    https://fonts.googleapis.com;
  
  font-src 
    'self' 
    https://fonts.gstatic.com 
    netdna.bootstrapcdn.com 
    data:;
  
  img-src 
    'self' 
    data: 
    blob: 
    https://storage.googleapis.com 
    https://chisquares.com/ 
    https://api.chisquares.com/api/ 
    https://cdn.jsdelivr.net/;
  
  frame-src 
    'self' 
    https://js.stripe.com 
    https://www.google.com 
    https://www.recaptcha.net/;
  
  form-action 'self';" always;

    # CORS Headers (Allow cross-origin requests)
    add_header Access-Control-Allow-Origin "$http_origin" always;
    add_header Vary "Origin";
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE";
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Auth-Key";
    
    # HSTS (Force HTTPS)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";

    # Referrer Policy
    add_header Referrer-Policy "origin";

    # Permissions Policy
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), fullscreen=(), payment=(), sync-xhr=()";

    # Remove X-Powered-By header
    server_tokens off;

    # Static File Handling
    location ~* \.(json|svg|woff|woff2|pem|ttf|eot)$ {
        types {
            application/json json;
            image/svg+xml svg;
            font/woff woff;
            font/woff2 woff2;
            application/x-pem-file pem;
            application/x-font-ttf ttf;
            application/vnd.ms-fontobject eot;
        }
    }

    # Handle Preflight (CORS) Requests Properly;
    location / {
      if ($request_method = OPTIONS) {
          add_header Access-Control-Allow-Origin "$http_origin" always;
          add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE";
          add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Auth-Key";
          return 204;
      }
      try_files $uri $uri/ /index.html;
    }
  }
}